@{
    var currentDoc = (MMCV_Model.Document.DocumentBO)Model.Item2;
    var currentUser = MMCV_Model.User.UserBO.Current.CurrentUser();
}

@section styles{
    <link rel="stylesheet" href="../Content/style.css" />
    <style>
        /*.card {
            box-shadow: 0 0px 3px 0px #9d9ba9 !important;
        }*/

        .sign-email {
            margin-bottom: 5px !important;
        }

        @@media screen and (max-width: 400px) {
            .pdf-page .right-panel {
                position: fixed;
                right: 0;
                bottom: 0;
                left: 0;
                z-index: 1030;
            }

            .pdf-page .mid-panel {
                margin-bottom: 137px;
            }
        }
    </style>
}

<div class="pt-3 pl-4 pr-4 pdf-page">
    <div class="row pl-1 mb-3">
        <button class="btn btn-success btn-sm" onclick="backPrePage()"><i class="la flaticon-left-arrow"></i>&nbsp;Back</button>
    </div>
    <div class="row">
        <div class="col-md-3 pl-1 pr-1">
            <div class="card">
                <div class="card-body p-2">
                    <div class="col-md-12 m-0 p-0 pl-1">
                        @*<div class="document-file">
                                <label><strong>Document file</strong></label>
                                <div class="custom-file">
                                    <input type="file" id="file_upload" class="custom-file-input" name="file_upload" accept=".pdf">
                                    <label class="custom-file-label" for="customFile">Choose file</label>
                                </div>
                            </div>
                            <hr />*@
                        <div class="mt-2 general-info">
                            <lable class=""><strong>General information</strong></lable>
                            <hr />
                            <div>
                                <strong>Issuer</strong>: <span id="txtIssuer">@currentDoc.Issuer</span>
                            </div>
                            <div>
                                <strong>Document Type</strong>: <span id="txtDocumentType"></span>
                            </div>
                            <div>
                                <strong>Header</strong>: <span id="txtHeader">@currentDoc.Title</span>
                            </div>
                            <div>
                                <strong>DocumentLink</strong>: <span id="txtDocumentLink">@currentDoc.Link</span>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
            <hr />
            <div class="card">
                <div class="card-body p-2">
                    <div class="col-md-12 m-0 p-0 pl-1">
                        <lable class=""><strong>List order sign via email</strong> </lable>
                        <hr />
                        <button class="btn btn-primary btn-sm w-100 mb-2" onclick="addSignature()" title="place your signature into document"><i class="fa fa-sign"></i> &nbsp; Sign signature here</button>
                        <button class="btn btn-secondary btn-sm w-100" onclick="addStamp()" title="place your stamp into document"><i class="fa fa-stamp"></i> &nbsp; Sign stamp here</button>
                        <div class="mt-3 list-receiver-email">
                            @foreach (var item in Model.Item2.DocumentSigns)
                            {
                                <div class="card badge badge-danger sign-email">@(item.SignIndex).@item.Email</div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-7 pl-1 pr-1 mid-panel">
            <div class="card m-0">
                <div class="card-body p-2">
                    <div id="viewer"></div>
                </div>
            </div>
        </div>

        <div class="col-md-2 pl-1 pr-1 right-panel">
            <div class="card m-0">
                <div class="card-body p-2">
                    <div class="col-md-12 m-0 p-0">
                        <button class="btn btn-success w-100" id="btn_send_file" title="save signature and send email to signer"> <i class="fa fa-save"></i>&nbsp; Save and send</button>
                        <hr />
                        @if (currentDoc.Issuer != currentUser.Email)
                        {
                            <button class="btn btn-light w-100" onclick="openModalDecline()" title="Decline sign then send an email to issuer"> <i class="fa fa-ban text-danger"></i>&nbsp; Decline</button>
                        }
                        else
                        {
                            <button class="btn btn-light w-100" onclick="openModalCancel()" title="Cancel sign then send mail to all signer"> <i class="fa fa-ban text-danger"></i>&nbsp; Cancel</button>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="declineModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Decline reason</h4>
                <button type="button" class="text-danger close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body pt-0">
                <div class="mb-2">
                    <strong>Reason</strong>
                    <input type="text" class="form-control w-100" id="txtDocumentSignNote" autofocus="">
                </div>
            </div>
            <div class="modal-footer pt-2 pb-2">
                <button class="btn btn-success" onclick="decline()">Submit</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="cancelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Cancel reason</h4>
                <button type="button" class="text-danger close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body pt-0">
                <div class="mb-2">
                    <strong>Reason</strong>
                    <input type="text" class="form-control w-100" id="txtDocumentNote" autofocus="">
                </div>
            </div>
            <div class="modal-footer pt-2 pb-2">
                <button class="btn btn-success" onclick="cancel()">Submit</button>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script src="../Scripts/lib/webviewer.min.js"></script>
    <script src="../Scripts/old-browser-checker.js"></script>
    <script src="../Scripts/global.js"></script>
    <script src="../Scripts/modernizr.custom.min.js"></script>
    <script>
        /*
        * Variables
        * */
        var baseUrl = "/Home/";

        /*
         * Methods
         */
        function backPrePage() {
            window.location.href = "/DocumentManagement/DocumentManagement";
        }

        $(document).ready(function () {
            $('iframe').on('load', function () {
                setTimeout(() => {
                    $("iframe").contents().find(".divider").css("display", "none");
                    $("iframe").contents().find(".HeaderToolsContainer").css("display", "none");
                    $("iframe").contents().find(".ToolsOverlayContainer").css("display", "none");
                    $("iframe").contents().find("[data-element=signatureToolGroupButton]").css("display", "none");
                    $("iframe").contents().find("[data-element=fileAttachmentToolGroupButton]").css("display", "none");
                    $("iframe").contents().find("[data-element=stampToolGroupButton]").css("display", "none");
                    $("iframe").contents().find("[data-element=calloutToolGroupButton]").css("display", "none");

                    $("iframe").contents().find("[data-element=searchButton]").css("display", "none");
                    $("iframe").contents().find("[data-element=toggleNotesButton]").css("display", "none");
                }, 100)
            });

            $(".btn-minimize").trigger("click");
        });

        $(".custom-file-input").on("change", function () {
            var fileName = $(this).val().split("\\").pop();
            $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
        });

        const input = document.getElementById('file_upload');
        const btnSendFile = document.getElementById('btn_send_file');
        var addSignature;
        var listUserSignature = [];

        WebViewer(
            {
                path: '/Scripts/lib',
                fullAPI: true,
            },
            document.getElementById('viewer')
        ).then(instance => {
            //var FitMode = instance.UI.FitMode;
            //instance.UI.setFitMode(FitMode.FitWidth);
            instance.UI.setZoomLevel('100%');
            // Load document to viewer
            function base64ToArrayBuffer(base64) {
                var binaryString = window.atob(base64);
                var binaryLen = binaryString.length;
                var bytes = new Uint8Array(binaryLen);
                for (var i = 0; i < binaryLen; i++) {
                    var ascii = binaryString.charCodeAt(i);
                    bytes[i] = ascii;
                }
                return bytes;
            }

            var arrayByte = base64ToArrayBuffer("@currentDoc.Base64File");
            var blob = new Blob([arrayByte], { type: "application/pdf" });
            instance.UI.loadDocument(blob, { filename: "test.pdf" });

            const { setHeaderItems, enableElements, disableElements, enableFeatures, disableFeatures, setTheme, Feature } = instance.UI;

            //instance.UI.setToolbarGroup('toolbarGroup-Insert');
            disableElements(['toolbarGroup-Insert']);
            disableElements(['toolbarGroup-Edit']);
            disableElements(['toolbarGroup-View']);
            disableElements(['toolbarGroup-Annotate']);
            disableElements(['toolbarGroup-Shapes']);
            disableElements(['toolbarGroup-Measure']);
            disableElements(['toolbarGroup-FillAndSign']);
            disableElements(['toolbarGroup-Forms']);
            disableElements(['leftPanel', 'leftPanelButton']);

            var base64Image = "data:image/png;base64,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gACBiQQEtokgXaaXwF2BTVjrxecgAgQIEDiqgMB21J5v0+5Lga2GNZvhtukTpRIgQIDABgQEtg100o6qeB7YbNuxo87VFAIECBCYT0Bgm8/WlV8sUAPahzr7qr07yathESBAgAABAncLCGxGx5ICNbCVMq0EXVJeWQQIECCwaQGBbdPdt7nK18DmebXNdZ0KEyBAgEBLAYGtpb6yCRAgQIAAAQI9BAS2HkgOIUCAAAECBAi0FBDYWuormwABAgQIECDQQ0Bg64HkEAIECBAgQIBASwGBraW+sgkQIECAAAECPQQEth5IDiFAgAABAgQItBQQ2FrqK5sAAQIECBAg0ENAYOuB5BACBAgQIECAQEsBga2lvrIJECBAgAABAj0EBLYeSA4hQIAAAQIECLQUENha6iubAAECBAgQINBDQGDrgeQQAgQIECBAgEBLAYGtpb6yCRAgQIAAAQI9BAS2HkgOIUCAAAECBAi0FBDYWuormwABAgQIECDQQ0Bg64HkEAIECBAgQIBASwGBraW+sgkQIECAAAECPQQEth5IDiFAgAABAgQItBQQ2FrqK5sAAQIECBAg0ENAYOuB5BACBAgQIECAQEsBga2lvrIJECBAgAABAj0EBLYeSA4hQIAAAQIECLQUENha6iubAAECBAgQINBDQGDrgeQQAgQIECBAgEBLAYGtpb6yCRAgQIAAAQI9BAS2HkgOIUCAAAECBAi0FBDYWuormwABAgQIECDQQ0Bg64HkEAIECBAgQIBASwGBraW+sgkQIECAAAECPQQEth5IDiFAgAABAgQItBT4P9z2Zb96WCIaAAAAAElFTkSuQmCC";
            const { documentViewer, annotationManager, Annotations } = instance.Core;
            // set current user for anntonation manager to avoid an user can modified other user's annotation
            annotationManager.setCurrentUser("@currentUser.Email");

            // rubber stamp
            const stampTool = documentViewer.getTool('AnnotationCreateRubberStamp');

            const customStamps = [
                { title: "@currentUser.Fullname", subtitle: "[@currentUser.DepartmentID]", color: new Annotations.Color('#33b837') },
            ]
            stampTool.setStandardStamps([ ]);
            stampTool.setCustomStamps(customStamps)

            addSignature = function() {
                // vẽ sẵn chữ ký tại một điểm
                const annot = new Annotations.StampAnnotation({
                    PageNumber: documentViewer.getCurrentPage(),
                    X: 100,
                    Y: 100,
                    Width: 200,
                    Height: 100,
                    Author: "@currentUser.Email"
                });
                annot.setImageData("@Model.Item3.Base64Signature");

                annotationManager.addAnnotation(annot);
                annotationManager.redrawAnnotation(annot);

                // user define check add
                listUserSignature.push(annot);
            }

            addStamp = function() {
                // vẽ sẵn dấu tại một điểm
                const annot = new Annotations.StampAnnotation({
                    PageNumber: documentViewer.getCurrentPage(),
                    X: 300,
                    Y: 100,
                    Width: 200,
                    Height: 200,
                    Author: "@currentUser.Email"
                });
                annot.setImageData("@currentUser.StampBase64");

                annotationManager.addAnnotation(annot);
                annotationManager.redrawAnnotation(annot);
            }

            annotationManager.addEventListener('annotationChanged', (annotations, action) => {
                if (action === 'add') {

                } else if (action === 'modify') {

                } else if (action === 'delete') {
                    annotations.forEach((annot) => {
                        if (annot.Author == "@currentUser.Email") {
                            var index = listUserSignature.indexOf(annot);
                            listUserSignature.splice(index, 1)
                        }
                    });
                }

                //annotations.forEach((annot) => {
                //    console.log(annot);
                //    console.log('annotation page number', annot.PageNumber);
                //});
            });

            function updateDocumentAfterSigning() {
                const req = new XMLHttpRequest();
                req.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        LoadingHide();
                        let result = JSON.parse(this.responseText);
                        if (result.rs) {
                            toastr.success(result.msg, "Success");
                            setTimeout(() => {
                                window.location.href = "/DocumentManagement/DocumentManagement";
                            }, 1000)
                        }
                        else {
                            toastr.error(result.msg, "Warning");
                        }
                    }
                };
                req.open("POST", '/Home/UpdateDocumentAfterSigning', true);
                req.setRequestHeader("Content-type", "application/json; charset=utf-8");

                LoadingShow();
                let data = {
                    DocumentID: @currentDoc.DocumentID,
                    Issuer: "@currentDoc.Issuer",
                    ReferenceCode: "@currentDoc.ReferenceCode"
                };

                req.send(JSON.stringify(data));
            }

            async function saveFile() {
                if (listUserSignature.length <= 0) {
                    toastr.error("You need to put your signature", "Warning");
                    return false;
                }
                LoadingShow();
                const doc = documentViewer.getDocument();
                const xfdfString = await annotationManager.exportAnnotations();
                const data = await doc.getFileData({
                    // saves the document with annotations in it
                    xfdfString
                });
                const arr = new Uint8Array(data);
                const blob = new Blob([arr], { type: 'application/pdf; charset=utf-8' });

                // save file and signature
                const frmData = new FormData();
                frmData.append('@currentDoc.Link', blob, '@currentDoc.Link');
                frmData.append("docId", '@currentDoc.DocumentID');

                const req = new XMLHttpRequest();
                req.open("POST", '/Home/SaveFileAndSignature', true);
                req.onload = function (oEvent) {
                    LoadingHide();
                    let response = JSON.parse(oEvent.target.responseText);
                    if (response.rs) {
                        updateDocumentAfterSigning();
                    }
                    else {
                        toastr.error(response.msg, "Error");
                    }
                };

                req.send(frmData);
            }
            btnSendFile.addEventListener("click", saveFile);

            //documentViewer.addEventListener("documentLoaded", () => {
            //    const flags = new instance.Core.Annotations.WidgetFlags({});
            //    flags.set('Required', true);
            //    let field = new instance.Core.Annotations.Forms.Field(
            //        "field1Test",
            //        {
            //            type: 'Sig',
            //            flags: flags,
            //        });
            //    let inputAnnot = new instance.Core.Annotations.SignatureWidgetAnnotation(field, {
            //        appearance: '_DEFAULT',
            //        appearances: {
            //            _DEFAULT: {
            //                Normal: {
            //                    data:
            //                        'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjEuMWMqnEsAAAANSURBVBhXY/j//z8DAAj8Av6IXwbgAAAAAElFTkSuQmCC',
            //                    offset: {
            //                        x: 100,
            //                        y: 100,
            //                    },
            //                },
            //            },
            //        },
            //    });

            //    inputAnnot.PageNumber = 1;
            //    inputAnnot.X = 100;
            //    inputAnnot.Y = 100;
            //    inputAnnot.Width = 50;
            //    inputAnnot.Height = 20;

            //    annotationManager.addAnnotation(inputAnnot);
            //    annotationManager.drawAnnotationsFromList([inputAnnot]);
            //    annotationManager.getFieldManager().addField(field);
            //});

        });

        function openModalDecline() {
            $("#declineModal").modal("show");
            $("#txtDocumentSignNote").focus();
        }

        function decline() {
            let note = $("#txtDocumentSignNote");
            if (!CheckNullOrEmpty(note, "Decline reason can not be null or empty"))
                return false;

            let action = baseUrl + 'Decline';
            var datasend = {
                DocumentID: @currentDoc.DocumentID,
                Issuer: "@currentDoc.Issuer",
                ReferenceCode: "@currentDoc.ReferenceCode",
                note: note.val()
            };

            LoadingShow();
            PostDataAjax(action, datasend, function (response) {
                LoadingHide();
                if (response.rs) {
                    toastr.success(response.msg, "Success");
                    setTimeout(() => {
                        backPrePage();
                    }, 1000);
                }
                else {
                    toastr.error(response.msg, "Warning");
                }
            });
        }

        function openModalCancel() {
            $("#cancelModal").modal("show");
            $("#txtDocumentNote").focus();
        }

        function cancel() {
            let note = $("#txtDocumentNote");
            if (!CheckNullOrEmpty(note, "Cancel reason can not be null or empty"))
                return false;

            let action = baseUrl + 'Cancel';
            var datasend = {
                DocumentID: @currentDoc.DocumentID,
                Issuer: "@currentDoc.Issuer",
                ReferenceCode: "@currentDoc.ReferenceCode",
                note: note.val()
            };

            LoadingShow();
            PostDataAjax(action, datasend, function (response) {
                LoadingHide();
                if (response.rs) {
                    toastr.success(response.msg, "Success");
                    setTimeout(() => {
                        backPrePage();
                    }, 1000);
                }
                else {
                    toastr.error(response.msg, "Warning");
                }
            });
        }

    </script>
}